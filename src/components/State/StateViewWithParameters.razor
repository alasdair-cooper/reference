@using System.Collections
@using System.Diagnostics
@using System.Diagnostics.CodeAnalysis
@using Microsoft.Extensions.Options

@typeparam TParameters
@typeparam T

<ErrorBoundary>
    <ChildContent>
        @if (Policy is not null || Roles is not null || Resource is not null)
        {
            <AuthorizeView
                Policy="@Policy"
                Roles="@Roles"
                Resource="@Resource">
                <Authorized>
                    @_renderState?.Invoke(_state)
                </Authorized>
                <Authorizing>
                    @_renderLoading?.Invoke(LoadingStateViewData.FromState(Store.NewLoadingState(), _timeProvider.GetUtcNow(), LoadStoreWithStateHandler))
                </Authorizing>
                <NotAuthorized>
                    @_renderUnauthorized?.Invoke(new UnauthorizedStateViewData(context.User, Resource, new AuthorizeData(Policy, Roles), _timeProvider.GetUtcNow(), LoadStoreWithStateHandler))
                </NotAuthorized>
            </AuthorizeView>
        }
        else
        {
            @_renderState?.Invoke(_state)
        }
    </ChildContent>
    <ErrorContent>
        @_renderError?.Invoke(new ErrorStateViewData(context, _timeProvider.GetUtcNow(), LoadStoreWithStateHandler))
    </ErrorContent>
</ErrorBoundary>

@code {

    private readonly TimeProvider _timeProvider;

    private StateViewData? _state;

    private readonly RenderFragment<StateViewData?>? _renderState;
    private readonly RenderFragment<ErrorStateViewData>? _renderError;
    private readonly RenderFragment<UnauthorizedStateViewData>? _renderUnauthorized;
    private readonly RenderFragment<LoadingStateViewData>? _renderLoading;

    public StateViewWithParameters(TimeProvider timeProvider)
    {
        _timeProvider = timeProvider;

        _renderError = x => ErrorContent?.Invoke(x) ?? Options.Value.DefaultErrorContent?.Invoke(x) ?? StateDefaults.DefaultContent.Empty;
        _renderUnauthorized = x => UnauthorizedContent?.Invoke(x) ?? Options.Value.DefaultUnauthorizedContent?.Invoke(x) ?? StateDefaults.DefaultContent.Empty;
        _renderLoading = x => LoadingContent?.Invoke(x) ?? Options.Value.DefaultLoadingContent?.Invoke(x) ?? StateDefaults.DefaultContent.Empty;

        _renderState =
            x =>
                x switch
                {
                    SuccessStateViewData<T> successState => SuccessContent?.Invoke(successState) ?? SuccessOrNotFoundContent?.Invoke(new SuccessOrNotFoundStateViewData<T>(successState, null)) ?? ChildContent?.Invoke(successState) ?? throw new InvalidOperationException($"State view must have either {nameof(SuccessContent)}, {nameof(SuccessOrNotFoundContent)} or {nameof(ChildContent)} defined."),
                    NotFoundStateViewData notFound => SuccessOrNotFoundContent?.Invoke(new SuccessOrNotFoundStateViewData<T>(null, notFound)) ?? NotFoundContent?.Invoke(notFound) ?? Options.Value.DefaultNotFoundContent?.Invoke(notFound),
                    ErrorStateViewData errorState => _renderError(errorState),
                    TimedOutStateViewData timedOutState => TimedOutContent?.Invoke(timedOutState) ?? Options.Value.DefaultTimedOutContent?.Invoke(timedOutState),
                    LoadingStateViewData loadingState => _renderLoading(loadingState),
                    _ => throw new UnreachableException()
                }
                ?? StateDefaults.DefaultContent.Empty;
    }

    [Parameter]
    [EditorRequired]
    public required StateStore<TParameters, T> Store { get; set; }

    [Parameter]
    public TParameters Parameters
    {
        get;
        set
        {
            switch (value, field)
            {
                case (null, null):
                case (IStructuralEquatable a, IStructuralEquatable b) when a.Equals(b):
                case (IEquatable<TParameters> c, IEquatable<TParameters> d) when c.Equals(d):
                    return;
                default:
                    field = value;
                    InvokeAsync(LoadStoreWithStateHandler);
                    return;
            }
        }
    } = default!;

    [Parameter]
    public RenderFragment<SuccessStateViewData<T>>? ChildContent { get; set; }

    [Parameter]
    public RenderFragment<SuccessStateViewData<T>>? SuccessContent { get; set; }

    [Parameter]
    public RenderFragment<SuccessOrNotFoundStateViewData<T>>? SuccessOrNotFoundContent { get; set; }

    [Parameter]
    public RenderFragment<LoadingStateViewData>? LoadingContent { get; set; }

    [Parameter]
    public RenderFragment<TimedOutStateViewData>? TimedOutContent { get; set; }

    [Parameter]
    public RenderFragment<ErrorStateViewData>? ErrorContent { get; set; }

    [Parameter]
    public RenderFragment<NotFoundStateViewData>? NotFoundContent { get; set; }

    [Parameter]
    public RenderFragment<UnauthorizedStateViewData>? UnauthorizedContent { get; set; }

    [Parameter]
    public string? Policy { get; set; }

    [Parameter]
    public string? Roles { get; set; }

    [Parameter]
    public object? Resource { get; set; }

    [Parameter]
    public Action<StateOptions>? ConfigureOptions { get; set; }

    [Parameter]
    public StateInitialLoadEvent InitialLoadEvent { get; set; } = StateInitialLoadEvent.OnInitialized;

    private IOptions<StateOptions> Options => Store.Options(ConfigureOptions);

    protected override void OnInitialized()
    {
        if (InitialLoadEvent is StateInitialLoadEvent.OnInitialized)
        {
            LoadStoreWithStateHandler();
        }
    }

    protected override void OnParametersSet()
    {
        if (InitialLoadEvent is StateInitialLoadEvent.OnParametersSet)
        {
            LoadStoreWithStateHandler();
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && InitialLoadEvent is StateInitialLoadEvent.OnAfterRender)
        {
            LoadStoreWithStateHandler();
        }
    }

    private void LoadStoreWithStateHandler()
    {
        Store.StateChanged -= OnStateChanged;
        Store.StateChanged += OnStateChanged;

        _ = Store.LoadAsync(Parameters);

        return;

        void OnStateChanged(object? _, State state)
        {
            _state = StateViewData.FromState<T>(state, _timeProvider.GetUtcNow(), LoadStoreWithStateHandler);
            InvokeAsync(StateHasChanged);
        }
    }

    public bool TryGetCurrentState<TViewData>([NotNullWhen(true)] out TViewData currentViewData) where TViewData : StateViewData
    {
        if (_state is TViewData viewData)
        {
            currentViewData = viewData;
            return true;
        }

        currentViewData = null!;
        return false;
    }

}