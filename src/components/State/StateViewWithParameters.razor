@using System.Collections
@using System.Diagnostics.CodeAnalysis
@using Microsoft.Extensions.Options

@typeparam TParameters
@typeparam T

<ErrorBoundary>
    <ChildContent>
        @if (Policy is not null || Roles is not null || Resource is not null)
        {
            <AuthorizeView
                Policy="@Policy"
                Roles="@Roles"
                Resource="@Resource">
                <Authorized>
                    @_renderState?.Invoke(_state)
                </Authorized>
                <Authorizing>
                    @_renderLoading?.Invoke(new LoadingState())
                </Authorizing>
                <NotAuthorized>
                    @_renderUnauthorized?.Invoke(context)
                </NotAuthorized>
            </AuthorizeView>
        }
        else
        {
            @_renderState?.Invoke(_state)
        }
    </ChildContent>
    <ErrorContent>
        @_renderError?.Invoke(new ErrorState(context))
    </ErrorContent>
</ErrorBoundary>

@code {

    private State? _state;

    private readonly RenderFragment<State?>? _renderState;
    private readonly RenderFragment<ErrorState>? _renderError;
    private readonly RenderFragment<AuthenticationState>? _renderUnauthorized;
    private readonly RenderFragment<LoadingState>? _renderLoading;

    public StateViewWithParameters()
    {
        _renderError = x => ErrorContent?.Invoke(x) ?? Options.Value.DefaultErrorContent?.Invoke(x) ?? StateDefaults.DefaultContent.Empty;
        _renderUnauthorized = x => UnauthorizedContent?.Invoke(new UnauthorizedState(x.User, Resource, new AuthorizeData(Policy, Roles))) ?? Options.Value.DefaultUnauthorizedContent?.Invoke(new UnauthorizedState(x.User, Resource, new AuthorizeData(Policy, Roles))) ?? StateDefaults.DefaultContent.Empty;
        _renderLoading = x => LoadingContent?.Invoke(x) ?? Options.Value.DefaultLoadingContent?.Invoke(x) ?? StateDefaults.DefaultContent.Empty;

        _renderState =
            x =>
                x switch
                {
                    SuccessState<T> successState => SuccessContent?.Invoke(successState) ?? SuccessOrNotFoundContent?.Invoke(new SuccessOrNotFoundState<T>(successState.Value)) ?? ChildContent?.Invoke(successState) ?? throw new InvalidOperationException($"State view must have either {nameof(SuccessContent)}, {nameof(SuccessOrNotFoundContent)} or {nameof(ChildContent)} defined."),
                    NotFoundState notFound => SuccessOrNotFoundContent?.Invoke(new SuccessOrNotFoundState<T>(default)) ?? NotFoundContent?.Invoke(notFound) ?? Options.Value.DefaultNotFoundContent?.Invoke(notFound),
                    ErrorState errorState => _renderError(errorState),
                    TimedOutState timedOutState => TimedOutContent?.Invoke(timedOutState) ?? Options.Value.DefaultTimedOutContent?.Invoke(timedOutState),
                    LoadingState loadingState => _renderLoading(loadingState),
                    _ => _renderLoading(new LoadingState())
                }
                ?? StateDefaults.DefaultContent.Empty;
    }

    [Parameter]
    [EditorRequired]
    public required StateStore<TParameters, T> Store { get; set; }

    [Parameter]
    public TParameters Parameters
    {
        get;
        set
        {
            switch (value, field)
            {
                case (null, null):
                case (IStructuralEquatable a, IStructuralEquatable b) when a.Equals(b):
                case (IEquatable<TParameters> c, IEquatable<TParameters> d) when c.Equals(d):
                    return;
                default:
                    field = value;
                    InvokeAsync(() => LoadStoreWithStateHandler(field));
                    return;
            }
        }
    } = default!;

    [Parameter]
    public RenderFragment<SuccessState<T>>? ChildContent { get; set; }

    [Parameter]
    public RenderFragment<SuccessState<T>>? SuccessContent { get; set; }

    [Parameter]
    public RenderFragment<SuccessOrNotFoundState<T>>? SuccessOrNotFoundContent { get; set; }

    [Parameter]
    public RenderFragment<LoadingState>? LoadingContent { get; set; }

    [Parameter]
    public RenderFragment<TimedOutState>? TimedOutContent { get; set; }

    [Parameter]
    public RenderFragment<ErrorState>? ErrorContent { get; set; }

    [Parameter]
    public RenderFragment<NotFoundState>? NotFoundContent { get; set; }

    [Parameter]
    public RenderFragment<UnauthorizedState>? UnauthorizedContent { get; set; }

    [Parameter]
    public string? Policy { get; set; }

    [Parameter]
    public string? Roles { get; set; }

    [Parameter]
    public object? Resource { get; set; }

    [Parameter]
    public Action<StateOptions>? ConfigureOptions { get; set; }

    [Parameter]
    public StateInitialLoadEvent InitialLoadEvent { get; set; } = StateInitialLoadEvent.OnInitialized;

    private IOptions<StateOptions> Options => Store.Options(ConfigureOptions);

    protected override void OnInitialized()
    {
        if (InitialLoadEvent is StateInitialLoadEvent.OnInitialized)
        {
            LoadStoreWithStateHandler(Parameters);
        }
    }

    protected override void OnParametersSet()
    {
        if (InitialLoadEvent is StateInitialLoadEvent.OnParametersSet)
        {
            LoadStoreWithStateHandler(Parameters);
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && InitialLoadEvent is StateInitialLoadEvent.OnAfterRender)
        {
            {
                LoadStoreWithStateHandler(Parameters);
            }
        }
    }

    private void LoadStoreWithStateHandler(TParameters parameters)
    {
        Store.StateChanged -= OnStateChanged;
        Store.StateChanged += OnStateChanged;

        _ = Store.LoadAsync(parameters);

        return;

        void OnStateChanged(object? _, State state)
        {
            _state = state;
            InvokeAsync(StateHasChanged);
        }
    }
    
    public bool TryGetCurrentState<TState>([NotNullWhen(true)] out TState currentState) where TState : State
    {
        if (_state is TState state)
        {
            currentState = state;
            return true;
        }

        currentState = null!;
        return false;
    }

}